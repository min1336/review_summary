{% extends "base.html" %}

{% block title %}Analytics{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Analytics Dashboard</h1>
        <p class="text-gray-500 mt-1">Overview of review sentiment and category distribution</p>
    </div>

    <!-- Loading -->
    <div id="analytics-loading" class="flex justify-center py-20">
        <div class="loading-spinner"></div>
    </div>

    <!-- Error -->
    <div id="analytics-error" class="hidden text-center py-20">
        <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
        </svg>
        <h3 class="text-lg font-semibold text-gray-500">Failed to load analytics</h3>
        <p id="analytics-error-msg" class="text-gray-400 mt-1"></p>
    </div>

    <!-- Analytics Content -->
    <div id="analytics-content" class="hidden">
        <!-- Top Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Total Reviews</p>
                        <p id="total-reviews" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Avg Rating</p>
                        <p id="avg-rating" class="text-3xl font-bold text-yellow-500 mt-1">N/A</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Positive</p>
                        <p id="positive-count" class="text-3xl font-bold text-green-600 mt-1">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Negative</p>
                        <p id="negative-count" class="text-3xl font-bold text-red-600 mt-1">0</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
            <!-- Sentiment Distribution Chart -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                <h2 class="text-lg font-bold text-gray-900 mb-6">Sentiment Distribution</h2>
                <div id="sentiment-chart" class="space-y-4">
                    <!-- Bars will be inserted here -->
                </div>
            </div>

            <!-- Category Breakdown -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                <h2 class="text-lg font-bold text-gray-900 mb-6">Category Breakdown</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="pb-3 text-sm font-semibold text-gray-600">Category</th>
                                <th class="pb-3 text-sm font-semibold text-gray-600 text-center">Count</th>
                                <th class="pb-3 text-sm font-semibold text-gray-600 text-center">Avg Rating</th>
                            </tr>
                        </thead>
                        <tbody id="category-table-body"></tbody>
                    </table>
                    <div id="no-categories" class="hidden text-center text-gray-400 py-6">No category data available</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var SENTIMENT_COLORS = {
        positive: { bar: 'bg-green-500', text: 'text-green-700' },
        negative: { bar: 'bg-red-500', text: 'text-red-700' },
        neutral:  { bar: 'bg-gray-400', text: 'text-gray-700' },
        mixed:    { bar: 'bg-yellow-500', text: 'text-yellow-700' },
    };

    function buildSentimentChart(stats) {
        var chart = document.getElementById('sentiment-chart');
        chart.textContent = '';

        var total = stats.total || 1;
        var sentiments = ['positive', 'negative', 'neutral', 'mixed'];

        sentiments.forEach(function(sentiment) {
            var count = stats[sentiment] || 0;
            var pct = total > 0 ? Math.round((count / total) * 100) : 0;
            var colors = SENTIMENT_COLORS[sentiment];

            var row = document.createElement('div');

            var labelRow = document.createElement('div');
            labelRow.className = 'flex justify-between items-center mb-1';

            var label = document.createElement('span');
            label.className = 'text-sm font-medium capitalize ' + colors.text;
            label.textContent = sentiment;

            var valueSpan = document.createElement('span');
            valueSpan.className = 'text-sm text-gray-500';
            valueSpan.textContent = count + ' (' + pct + '%)';

            labelRow.appendChild(label);
            labelRow.appendChild(valueSpan);

            var barBg = document.createElement('div');
            barBg.className = 'w-full bg-gray-100 rounded-full h-4 overflow-hidden';

            var barFill = document.createElement('div');
            barFill.className = 'h-full rounded-full transition-all duration-700 ' + colors.bar;
            barFill.style.width = pct + '%';

            barBg.appendChild(barFill);
            row.appendChild(labelRow);
            row.appendChild(barBg);
            chart.appendChild(row);
        });
    }

    function buildCategoryTable(categories) {
        var tbody = document.getElementById('category-table-body');
        var noCats = document.getElementById('no-categories');
        tbody.textContent = '';

        if (!categories || categories.length === 0) {
            noCats.classList.remove('hidden');
            return;
        }

        var CATEGORY_BADGE_CLASSES = {
            product: 'bg-blue-100 text-blue-700',
            book: 'bg-purple-100 text-purple-700',
            restaurant: 'bg-orange-100 text-orange-700',
            movie: 'bg-pink-100 text-pink-700',
            other: 'bg-gray-100 text-gray-700',
        };

        categories.forEach(function(cat) {
            var tr = document.createElement('tr');
            tr.className = 'border-b border-gray-100';

            var nameTd = document.createElement('td');
            nameTd.className = 'py-3';
            var badge = document.createElement('span');
            badge.className = 'inline-block px-3 py-1 rounded-full text-xs font-medium capitalize ' +
                (CATEGORY_BADGE_CLASSES[cat.category] || CATEGORY_BADGE_CLASSES.other);
            badge.textContent = cat.category;
            nameTd.appendChild(badge);

            var countTd = document.createElement('td');
            countTd.className = 'py-3 text-center font-semibold text-gray-700';
            countTd.textContent = cat.count;

            var ratingTd = document.createElement('td');
            ratingTd.className = 'py-3 text-center';
            if (cat.avg_rating !== null && cat.avg_rating !== undefined) {
                var starSpan = document.createElement('span');
                starSpan.className = 'text-yellow-400 mr-1';
                starSpan.textContent = '\u2605';
                ratingTd.appendChild(starSpan);

                var ratingText = document.createTextNode(cat.avg_rating.toFixed(1));
                ratingTd.appendChild(ratingText);
            } else {
                ratingTd.textContent = '--';
                ratingTd.className += ' text-gray-400';
            }

            tr.appendChild(nameTd);
            tr.appendChild(countTd);
            tr.appendChild(ratingTd);
            tbody.appendChild(tr);
        });
    }

    async function loadAnalytics() {
        var loading = document.getElementById('analytics-loading');
        var errorEl = document.getElementById('analytics-error');
        var content = document.getElementById('analytics-content');

        try {
            var data = await fetchJSON('/api/v1/analytics/overview');
            loading.classList.add('hidden');

            // Top stats
            document.getElementById('total-reviews').textContent = data.total_reviews || 0;
            document.getElementById('avg-rating').textContent =
                data.avg_rating ? data.avg_rating.toFixed(1) : 'N/A';
            document.getElementById('positive-count').textContent =
                data.sentiment_stats ? data.sentiment_stats.positive : 0;
            document.getElementById('negative-count').textContent =
                data.sentiment_stats ? data.sentiment_stats.negative : 0;

            // Charts
            if (data.sentiment_stats) {
                buildSentimentChart(data.sentiment_stats);
            }
            buildCategoryTable(data.category_stats || []);

            content.classList.remove('hidden');
        } catch (err) {
            loading.classList.add('hidden');
            errorEl.classList.remove('hidden');
            document.getElementById('analytics-error-msg').textContent = err.message || 'Unknown error';
        }
    }

    document.addEventListener('DOMContentLoaded', loadAnalytics);
</script>
{% endblock %}
